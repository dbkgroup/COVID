---
title: "COVID discovery study"
---


```{r}
#library(reshape2)
library(formattable)
#library(gridExtra)
library(tidyverse)
library(magrittr)
#library(Biobase)
#library(lubridate)
library(glue)
source("Data_prep.R")
source("Data_viz.R")
source("Data_processing.R")
```



Loading Thermo's Compound Discoverer (CD) processed data

DiscoveryStudyB2-B5_pos.csv : hold exported results from Compound Discoverer (Thermo) ESI+ mode
DiscoveryStudyB2-B5_neg.csv : hold exported results from Compound Discoverer (Thermo) ESI- mode

DisciveryStudy_RunOrder.csv : acquisition sequence order - important for data normalization, the sequence was the same in ESI+ and ESI-

B2-B5_sample_mapping.csv : hold the information on sample mapping between hospital sample ID (important to relate to metadata) and LC-MS run ID (important to relate to acquired data)

! Remove dat aof birth !!!
COVID_all_metadata.csv : metadata associated to samples and patients 


```{r Load data, message=FALSE, include=FALSE}
data_pos <- read_csv("Data/DiscoveryStudyB2-B5_pos.csv", guess_max = 8000)
data_neg <- read_csv("Data/DiscoveryStudyB2-B5_neg.csv", guess_max = 8000)
data_order <- read_csv("Data/DisciveryStudy_RunOrder.csv", guess_max = 8000)
data_info <- read_csv("Data/B2-B5_sample_mapping.csv")
data_info_all <- read_csv("Data/COVID_all_metadata.csv")

data_info_plus <- data_order %>%
  drop_na() %>%
  separate(Sample, c("Condition", "Study", "Batch", "Sample"), sep = "_") %>%
  select(-c("Study", "Condition")) %>%
  left_join(data_info) 


# the ESI+ B2_SQA75 was forgotten from the in the pre-processing therefore mission to avoid error in the following code this sample is removed. 
data_pos_info_all <- data_info_plus %>% 
  filter(!(Batch == "B2" & Sample == "SQA75")) %>%
  left_join(data_info_all, by = "SampleID")



# The ESI- B4_GBX was actually named GB1 in the data pre-processing step and therefore it is renamed here to avoid conflicts in later code.
data_neg_info_all <- data_info_plus %>% 
  left_join(data_info_all, by = "SampleID") 

data_neg_info_all$Sample <- ifelse(data_neg_info_all$Batch == "B4" & data_neg_info_all$Sample == "GBX", "GB1", data_neg_info_all$Sample)

```

```{r Create area eset}
#eset_CD_area_pos <- covid_transform_to_eset(data_pos, data_pos_info_all %>% filter(Sample != "SQA75" | Batch != "B2") , normalized_areas = F, background = F, normalized = T)

eset_CD_area_pos <- covid_transform_to_eset(data_pos, data_pos_info_all, normalized_areas = F, background = F, normalized = T)

eset_CD_area_neg <- covid_transform_to_eset(data_neg, data_neg_info_all, normalized_areas = F, background = F, normalized = T)
```

```{r echo=FALSE}
formattable(get_basic_stats(get_compound_info_short_list(data_pos), "ESI+"), align =c("l","c"), 
            list(`Criteria` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold"))))
```

```{r echo=FALSE}
formattable(get_basic_stats(get_compound_info_short_list(data_neg), "ESI-"), align =c("l","c"), 
            list(`Criteria` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold"))))
```


PCA plot visualization of the raw areas by batch and group in ESI+ and ESI-
The data shows relatively little variation by batch but significant time drift in the QC

```{r}
p1_a <- get_pca_by_batch(eset_CD_area_pos, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI+ by batch", title_center = F)
p2_a <- get_pca_by_group(eset_CD_area_pos, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI+ by group", title_center = F)

p3_a <- get_pca_by_batch(eset_CD_area_neg, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI- by batch", title_center = F)
p4_a <- get_pca_by_group(eset_CD_area_neg, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI- by group", title_center = F)

gridExtra::grid.arrange(p1_a, p2_a, nrow = 1, ncol=2, respect = T, padding = unit(1, "mm"), top = textGrob("PCA for all injections ESI+", gp=gpar(fontfamily = "sans", fontsize=15,font=2)), widths = unit(c(93,95), c("mm", "mm")))

gridExtra::grid.arrange(p3_a, p4_a, nrow = 1, ncol=2, respect = T, padding = unit(1, "mm"), top = textGrob("PCA for all injections ESI-", gp=gpar(fontfamily = "sans", fontsize=15,font=2)), widths = unit(c(93,95), c("mm", "mm")))
```

Test the time drift QC based normalization on a compound in ESI+
```{r}
test_set <- eset_CD_area_pos[eset_CD_area_pos@featureData$Compound == "165.07877_2.583",]
eset_test_norm1 <- covid_normalize_by_batch_plot_correction(test_set)

```

Test the time drift QC based normalization on a compound in ESI-
```{r}
test_set <- eset_CD_area_neg[eset_CD_area_neg@featureData$Compound == "264.11096_5.361",]
eset_test_norm1 <- covid_normalize_by_batch_plot_correction(test_set)

```

Normalize the ESI+ data for QC based time drift per batch (each batch separately)
This part can take a lot of time

```{r Whitin batch normalization}
t_start <- Sys.time()
eset_norm1_pos <- covid_normalize_by_batch(eset_CD_area_pos)
Sys.time() - t_start
```

Normalize the ESI+ data for QC based time drift per batch (each batch separately)
This part can take a lot of time
```{r Whitin batch normalization}
t_start <- Sys.time()
eset_norm1_neg <- covid_normalize_by_batch(eset_CD_area_neg)
Sys.time() - t_start
```


Check on QC based time drift correction 
```{r}
p1_a <- get_pca_by_batch(eset_norm1_pos, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI+ by batch", title_center = F)
p2_a <- get_pca_by_group(eset_norm1_pos, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI+ by group", title_center = F)

p3_a <- get_pca_by_batch(eset_norm1_neg, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI- by batch", title_center = F)
p4_a <- get_pca_by_group(eset_norm1_neg, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI- by group", title_center = F)

gridExtra::grid.arrange(p1_a, p2_a, nrow = 1, ncol=2, respect = T, padding = unit(1, "mm"), top = textGrob("PCA for all injections ESI+", gp=gpar(fontfamily = "sans", fontsize=15,font=2)), widths = unit(c(93,95), c("mm", "mm")))

gridExtra::grid.arrange(p3_a, p4_a, nrow = 1, ncol=2, respect = T, padding = unit(1, "mm"), top = textGrob("PCA for all injections ESI-", gp=gpar(fontfamily = "sans", fontsize=15,font=2)), widths = unit(c(93,95), c("mm", "mm")))
```


Normalize between batches ESI+
```{r Between batch normalization}
source("Data_processing.R")
t_start <- Sys.time()
eset_norm2_pos <- covid_normalize_between_batches(eset_norm1_pos)
Sys.time() - t_start   
```



Normalize between batches ESI-
```{r Between batch normalization}
source("Data_processing.R")
t_start <- Sys.time()
eset_norm2_neg <- covid_normalize_between_batches(eset_norm1_neg)
Sys.time() - t_start   
```



Check on data after both normalizations  
```{r}
p1_a <- get_pca_by_batch(eset_norm2_pos, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI+ by batch", title_center = F)
p2_a <- get_pca_by_group(eset_norm2_pos, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI+ by group", title_center = F)

p3_a <- get_pca_by_batch(eset_norm2_neg, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI- by batch", title_center = F)
p4_a <- get_pca_by_group(eset_norm2_neg, c("QC", "Sample", "IQA", "SQA"), labels = F, title = "ESI- by group", title_center = F)

gridExtra::grid.arrange(p1_a, p2_a, nrow = 1, ncol=2, respect = T, padding = unit(1, "mm"), top = textGrob("PCA for all injections ESI+", gp=gpar(fontfamily = "sans", fontsize=15,font=2)), widths = unit(c(93,95), c("mm", "mm")))

gridExtra::grid.arrange(p3_a, p4_a, nrow = 1, ncol=2, respect = T, padding = unit(1, "mm"), top = textGrob("PCA for all injections ESI-", gp=gpar(fontfamily = "sans", fontsize=15,font=2)), widths = unit(c(93,95), c("mm", "mm")))
```


As normalization is time consuming activity I like to save the results so I can restart on later dates form here
```{r Save / Load normalized data sets}
#save(eset_norm2_pos, file = "Data/Norm2_eset_pos.RData")

load(file = "Data/Norm2_eset_pos.RData")
```

```{r Save / Load normalized data sets}
#save(eset_norm2_neg, file = "Data/Norm2_eset_neg.RData")

load(file = "Data/Norm2_eset_neg.RData")
```


## Data filtering

Remove all compounds where 20% of the QC were not detected and 75% of the samples were not detected
Remove all compounds where Predicted composition failed
```{r}
#ESI+
data_pos <- eset_norm2_pos %>% remove_compounds(c("QC"), 0.2) %>% remove_compounds(c("Sample"), 0.75)
data_pos_filter <- data_pos[data_pos@featureData$Predicted_Composition == "Full match",]

#ESI-
data_neg <- eset_norm2_neg %>% remove_compounds(c("QC"), 0.2) %>% remove_compounds(c("Sample"), 0.75)
data_neg_filter <- data_neg[data_neg@featureData$Predicted_Composition == "Full match",]
```

## Add Labels of interest
We are adding here a logical version (for models) and character version (for visuals)
```{r}
#ESI+
data_pos_filter@phenoData$Severe = case_when(
  data_pos_filter@phenoData$Severity == "Mild" ~ F,
  data_pos_filter@phenoData$Severity == "Int" ~ F,
  data_pos_filter@phenoData$Severity == "Severe" ~ T,
  TRUE ~ NA)

data_pos_filter@phenoData$SevereL = case_when(
  data_pos_filter@phenoData$Severity == "Mild" ~ "Mild",
  data_pos_filter@phenoData$Severity == "Int" ~ "Mild",
  data_pos_filter@phenoData$Severity == "Intermediate" ~ "Mild",
  data_pos_filter@phenoData$Severity == "Severe" ~ "Severe",
  TRUE ~ as.character(NA))

data_pos_filter@phenoData$Deceased = case_when(
  data_pos_filter@phenoData$Outcome == "Discharge" ~ F,
  data_pos_filter@phenoData$Outcome == "Deceased" ~ T,
  data_pos_filter@phenoData$Outcome == "Ongoing (COV2 negative, currently in neuro rehab)" ~ F,
  TRUE ~ NA)

data_pos_filter@phenoData$DeceasedL = case_when(
  data_pos_filter@phenoData$Outcome == "Discharge" ~ "Discharged",
  data_pos_filter@phenoData$Outcome == "Deceased" ~ "Deceased",
  data_pos_filter@phenoData$Outcome == "Ongoing (COV2 negative, currently in neuro rehab)" ~ "Discharged",
  TRUE ~ as.character(NA))

#ESI-
data_neg_filter@phenoData$Severe = case_when(
  data_neg_filter@phenoData$Severity == "Mild" ~ F,
  data_neg_filter@phenoData$Severity == "Int" ~ F,
  data_neg_filter@phenoData$Severity == "Severe" ~ T,
  TRUE ~ NA)

data_neg_filter@phenoData$SevereL = case_when(
  data_neg_filter@phenoData$Severity == "Mild" ~ "Mild",
  data_neg_filter@phenoData$Severity == "Int" ~ "Mild",
  data_neg_filter@phenoData$Severity == "Intermediate" ~ "Mild",
  data_neg_filter@phenoData$Severity == "Severe" ~ "Severe",
  TRUE ~ as.character(NA))

data_neg_filter@phenoData$Deceased = case_when(
  data_neg_filter@phenoData$Outcome == "Discharge" ~ F,
  data_neg_filter@phenoData$Outcome == "Deceased" ~ T,
  data_neg_filter@phenoData$Outcome == "Ongoing (COV2 negative, currently in neuro rehab)" ~ F,
  TRUE ~ NA)

data_neg_filter@phenoData$DeceasedL = case_when(
  data_neg_filter@phenoData$Outcome == "Discharge" ~ "Discharged",
  data_neg_filter@phenoData$Outcome == "Deceased" ~ "Deceased",
  data_neg_filter@phenoData$Outcome == "Ongoing (COV2 negative, currently in neuro rehab)" ~ "Discharged",
  TRUE ~ as.character(NA))

```



# Volcano plots
First p-values (including  q-values) and fold change is calculated with Mann-Whitney than shown in a custom volcano plot

```{r All by severity}
#ESI+
#Severity
t_start <- Sys.time()
volc_data_s_pos <- get_fold_pvalue_mw(data_pos_filter, "Severe")
Sys.time() -  t_start   

get_volcano_plot(volc_data_s_pos, add_lables = F, foldChange_lable_lim = 2.5, p_value_lable_lim = 0.05, use_q_value = T)

#Outcome
t_start <- Sys.time()
volc_data_d_pos <- get_fold_pvalue_mw(data_pos_filter, "Deceased")
Sys.time() - t_start   

get_volcano_plot(volc_data_d_pos, add_lables = F, foldChange_lable_lim = 2.5, p_value_lable_lim = 0.05, use_q_value = T)

#ESI-
#Severity
t_start <- Sys.time()
volc_data_s_neg <- get_fold_pvalue_mw(data_neg_filter, "Severe")
Sys.time() -  t_start   

get_volcano_plot(volc_data_s_neg, add_lables = F, foldChange_lable_lim = 2.5, p_value_lable_lim = 0.05, use_q_value = T)

#Outcome
t_start <- Sys.time()
volc_data_d_neg <- get_fold_pvalue_mw(data_neg_filter, "Deceased")
Sys.time() - t_start   

get_volcano_plot(volc_data_d_neg, add_lables = F, foldChange_lable_lim = 2.5, p_value_lable_lim = 0.05, use_q_value = T)

```

Get the lowest q_value compounds per ESI mode and label of interest
```{r}
checkComp_s_pos <- volc_data_s_pos %>% filter(abs(FoldChangeLog2) > 0.5 & Q_value < 0.05) %>% arrange(desc(abs(FoldChangeLog2)))
checkComp_d_pos <- volc_data_d_pos %>% filter(abs(FoldChangeLog2) > 0.5 & Q_value < 0.05) %>% arrange(desc(abs(FoldChangeLog2)))

checkComp_s_neg <- volc_data_s_neg %>% filter(abs(FoldChangeLog2) > 0.5 & Q_value < 0.05) %>% arrange(desc(abs(FoldChangeLog2)))
checkComp_d_neg <- volc_data_d_neg %>% filter(abs(FoldChangeLog2) > 0.5 & Q_value < 0.05) %>% arrange(desc(abs(FoldChangeLog2)))

#ESI+ severity
comp <- (checkComp_s_pos %>% arrange(Q_value) %>% pull(Compound))[1]
temp <- volc_data_s_pos %>% filter(Compound == comp)
sub = glue("Q value = {format(temp$Q_value, digits = 3)}  /  Log2 Fold Change = {format(temp$FoldChangeLog2, digits = 3)}")
getBoxPlotForCompound(data_pos_filter, comp, y_log = T, "Severe", subtitle = sub)

#ESI+ outcome
comp <- (checkComp_d_pos %>% arrange(Q_value) %>% pull(Compound))[1]
temp <- volc_data_d_pos %>% filter(Compound == comp)
sub = glue("Q value = {format(temp$Q_value, digits = 3)}  /  Log2 Fold Change = {format(temp$FoldChangeLog2, digits = 3)}")
getBoxPlotForCompound(data_pos_filter, comp, y_log = T, "Deceased", subtitle = sub)

#ESI- severity
comp <- (checkComp_s_neg %>% arrange(Q_value) %>% pull(Compound))[1]
temp <- volc_data_s_neg %>% filter(Compound == comp)
sub = glue("Q value = {format(temp$Q_value, digits = 3)}  /  Log2 Fold Change = {format(temp$FoldChangeLog2, digits = 3)}")
getBoxPlotForCompound(data_neg_filter, comp, y_log = T, "Severe", subtitle = sub)

#ESI- outcome
comp <- (checkComp_d_neg %>% arrange(Q_value) %>% pull(Compound))[1]
temp <- volc_data_d_neg %>% filter(Compound == comp)
sub = glue("Q value = {format(temp$Q_value, digits = 3)}  /  Log2 Fold Change = {format(temp$FoldChangeLog2, digits = 3)}")
getBoxPlotForCompound(data_neg_filter, comp, y_log = T, "Deceased", subtitle = sub)
```







